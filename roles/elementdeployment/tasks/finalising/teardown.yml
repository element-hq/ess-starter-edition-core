# Copyright 2023-2024 New Vector Ltd
#
# SPDX-License-Identifier: AGPL-3.0-or-later


---
- name: "Find unused resources"
  vars:
    _label_selectors:
    - "app.kubernetes.io/managed-by=element-updater"
    - "k8s.element.io/crdhash!={{ _crd_spec_hash }}"
    - "k8s.element.io/crdhash"
  ansible.builtin.set_fact:
    _orphan_crds: |
      {% for kind_item in element_operator_crds %}
      {{ query('k8s',
                namespace=ansible_operator_meta.namespace,
                kind=kind_item.kind,
                api_version=kind_item.api_version,
                label_selector=_label_selectors | join(',')
              )
        | mapattributes(['apiVersion', 'kind', 'metadata'])
        | to_nice_yaml }}
      ---
      {% endfor %}

# Filter the above lists to remove items without
# an ownerReferences that refers to `kind: ElementDeployment`
# `name: {{ ansible_operator_meta.name }}`
# Doing as two step process for debugging

- name: "Filter resources managed by ElementDeployment CRD"
  ansible.builtin.set_fact:
    _filtered_kind: >-
      {{ _orphan_crds
          | split("---")
          | select
          | map('from_yaml')
          | map('json_query', query)
          | flatten
      }}
  vars:
    query: "[?metadata.ownerReferences[?kind == `ElementDeployment`]]"

- name: "Remove resources under control of something not named {{ ansible_operator_meta.name }}"
  ansible.builtin.set_fact:
    _filtered: "{{ _filtered_kind | json_query(query) }}"
  vars:
    query: "[?metadata.ownerReferences[?name == '{{ ansible_operator_meta.name }}']]"

- name: "Remove unused ElementDeployment resources - {{ item.kind ~ '/' ~ item.apiVersion ~ '/' ~ item.metadata.name }}"
  kubernetes.core.k8s:
    apply: true
    state: absent
    definition: >-
      {{
        _filtered
      }}

# Any Secrets/ConfigMaps/etc will be taken down by the generic teardown role
